
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - UTRA FASHION </title>
<style>
body{margin:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;display:flex;height:100vh;background:#f4f6f9;}
.sidebar{width:250px;background:#000;color:#fff;display:flex;flex-direction:column;padding:20px;}
.logo{text-align:center;margin-bottom:40px;}
.logo img{width:60px;border-radius:50%;}
.logo h2{margin:10px 0 0 0; font-size: 18px; letter-spacing: 1px;}
.nav-item{padding:15px;margin-bottom:10px;border-radius:8px;cursor:pointer; transition: 0.3s; font-weight: 500;}
.nav-item:hover, .nav-item.active{background:#222;color:#ffd700;}
.logout{margin-top:auto;background:#ff4d4d;text-align:center; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold;}
.main{flex:1;padding:40px;overflow:auto;}
.card{background:#fff;padding:25px;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.05);margin-bottom:25px;}

input, select, textarea{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #ddd; box-sizing: border-box; font-family: inherit;}
button{padding:10px 15px;border:none;border-radius:6px;cursor:pointer; font-weight: bold;}
.post-btn{width:100%;background:#007bff;color:#fff; padding: 12px; margin-top: 10px;}
.edit-btn{background:#ffc107; margin-right: 5px;}
.delete-btn{background:#dc3545;color:#fff;}

table{width:100%;border-collapse:collapse;}
th,td{padding:15px;border-bottom:1px solid #eee;text-align:left;}
.order-img{width:60px; height: 60px; object-fit: cover; border-radius:8px; border: 1px solid #ddd;}
.tab{display:none;}
.tab.active-tab{display:block;}

.buyer-info-box { font-size: 13px; line-height: 1.5; }
.buyer-name { font-weight: bold; color: #ff3f6c; font-size: 15px; display: block; margin-bottom: 3px; }
.status-select { padding: 8px; border-radius: 4px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; }
label { font-size: 12px; font-weight: bold; color: #555; margin-top: 5px; display: block; }

.size-selector { display: flex; gap: 15px; margin: 10px 0; background: #f9f9f9; padding: 10px; border-radius: 8px; }
.size-selector label { display: inline; margin-right: 5px; cursor: pointer; }
</style>
</head>

<body>

<div class="sidebar">
    <div class="logo">
        <img src="image.png" alt="Logo">
        <h2>UTRA FASHION</h2>
    </div>
    <div class="nav-item active" id="nav-dashboard" onclick="showTab('dashboard')">üìä Dashboard</div>
    <div class="nav-item" id="nav-addProduct" onclick="showTab('addProduct')">‚ûï Add Product</div>
    <div class="nav-item" id="nav-inventory" onclick="showTab('inventory')">üì¶ Inventory</div>
    <div class="nav-item" id="nav-orders" onclick="showTab('orders')">üßæ Orders</div>
    <div class="nav-item" id="nav-reviews" onclick="showTab('reviews')">‚≠ê Reviews</div>
    
    <div class="logout" onclick="logout()">üö™ Logout</div>
</div>

<div class="main">
    <div id="dashboard" class="tab active-tab">
        <div class="card">
            <h2>Dashboard Overview</h2>
            <div style="display: flex; gap: 20px;">
                <p style="font-size: 18px; background: #e8f4f8; padding: 15px; border-radius: 8px;">Total Products: <br><span id="total" style="color: #007bff; font-weight: bold; font-size: 24px;">0</span></p>
                <p style="font-size: 18px; background: #fff4e5; padding: 15px; border-radius: 8px;">Total Reviews: <br><span id="total-reviews" style="color: #ff9800; font-weight: bold; font-size: 24px;">0</span></p>
            </div>
        </div>
    </div>

    <div id="addProduct" class="tab">
        <div class="card">
            <h2 id="form-title">Add New Product (Options & Description)</h2>
            <input type="text" id="pName" placeholder="Product Name">
            <input type="number" id="pPrice" placeholder="Price (‚Çπ)">
            
            <label>Product Description:</label>
            <textarea id="pDesc" placeholder="Describe material, fabric, and style..." style="height: 100px;"></textarea>
            
            <label>Select Category:</label>
            <select id="pCategory">
                <option value="MEN">MEN</option>
                <option value="WOMEN">WOMEN</option>
                <option value="KIDS">KIDS</option>
                <option value="ALL">ALL/OTHERS</option>
            </select>

            <label>Available Sizes:</label>
            <div class="size-selector">
                <label><input type="checkbox" class="size-check" value="S"> S</label>
                <label><input type="checkbox" class="size-check" value="M"> M</label>
                <label><input type="checkbox" class="size-check" value="L"> L</label>
                <label><input type="checkbox" class="size-check" value="XL"> XL</label>
                <label><input type="checkbox" class="size-check" value="XXL"> XXL</label>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>1. Main Image (Front):</label>
                    <input type="file" id="pImage1" accept="image/*">
                    <label>2. Side View:</label>
                    <input type="file" id="pImage2" accept="image/*">
                    <label>3. Back View:</label>
                    <input type="file" id="pImage3" accept="image/*">
                </div>
                <div>
                    <label>4. Detail View 1:</label>
                    <input type="file" id="pImage4" accept="image/*">
                    <label>5. Detail View 2:</label>
                    <input type="file" id="pImage5" accept="image/*">
                    <label>6. Label/Tag View:</label>
                    <input type="file" id="pImage6" accept="image/*">
                </div>
            </div>
            
            <button class="post-btn" id="save-btn" onclick="saveProduct()">Save Product with Options</button>
            <p id="status-msg" style="text-align:center; font-weight:bold; margin-top:10px;"></p>
        </div>
    </div>

    <div id="inventory" class="tab">
        <div class="card">
            <h2>Inventory Control</h2>
            <table>
                <thead>
                    <tr><th>Image</th><th>Name & Status</th><th>Price</th><th>Action</th></tr>
                </thead>
                <tbody id="product-table"></tbody>
            </table>
        </div>
    </div>

    <div id="orders" class="tab">
        <div class="card">
            <h2>Buyer Live Orders</h2>
            <table>
                <thead>
                    <tr><th>Image</th><th>Product</th><th>Price</th><th>Buyer & Delivery Info</th><th>Status</th></tr>
                </thead>
                <tbody id="orders-table"></tbody>
            </table>
        </div>
    </div>

    <div id="reviews" class="tab">
        <div class="card">
            <h2>Customer Reviews & Feedback ‚≠ê</h2>
            <table>
                <thead>
                    <tr><th>Product Name</th><th>Reviewer Info</th><th>Rating & Comment</th><th>Date</th><th>Action</th></tr>
                </thead>
                <tbody id="reviews-table"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { 
    getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCax6078YpxQU0kHIChQLuEmpLUYXSxQr4",
  authDomain: "e-commerce-wepsite.firebaseapp.com",
  projectId: "e-commerce-wepsite",
  storageBucket: "e-commerce-wepsite.appspot.com",
  messagingSenderId: "394408704286",
  appId: "1:394408704286:web:9ad690a946b225ab20f10f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let editId = null;

onAuthStateChanged(auth, (user)=>{
    const isAdmin = localStorage.getItem("isAdminLoggedIn");
    if(!user || user.email !== "sureshrajagunam24@gmail.com" || isAdmin !== "true"){
        window.location.href="admin-login.html";
    } else {
        loadProducts();
        loadOrders();
        loadAllReviews(); // Load Reviews Function Added
    }
});

window.showTab = function(tabId){
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active-tab'));
    document.getElementById(tabId).classList.add('active-tab');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('nav-' + tabId).classList.add('active');
}

window.logout = function(){
    if(confirm("Logout from Admin Panel?")){
        signOut(auth).then(() => {
            localStorage.removeItem("isAdminLoggedIn");
            window.location.href="admin-login.html";
        });
    }
}

window.saveProduct = async function(){
    const name = document.getElementById("pName").value.trim();
    const price = document.getElementById("pPrice").value.trim();
    const desc = document.getElementById("pDesc").value.trim();
    const category = document.getElementById("pCategory").value; 
    const status = document.getElementById("status-msg");
    const selectedSizes = Array.from(document.querySelectorAll('.size-check:checked')).map(cb => cb.value);

    const files = [];
    for(let i=1; i<=6; i++) {
        const fileInput = document.getElementById("pImage" + i);
        files.push(fileInput.files[0] || null);
    }

    if(!name || !price || !files[0]){ 
        status.innerText="Name, Price and Main Image are mandatory! ‚ùå"; 
        return; 
    }
    status.innerText = "Processing Data... ‚è≥";

    const toBase64 = file => new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
    });

    try {
        const imgData = await Promise.all(files.map(f => f ? toBase64(f) : ""));
        const productObj = {
            productName: name, price: Number(price), description: desc, category: category, sizes: selectedSizes,
            imageUrl: imgData[0], imageUrl2: imgData[1], imageUrl3: imgData[2], 
            imageUrl4: imgData[3], imageUrl5: imgData[4], imageUrl6: imgData[5],
            inStock: true, 
            createdAt: serverTimestamp()
        };

        if(editId){
            await updateDoc(doc(db, "products", editId), productObj);
            editId = null; status.innerText="Updated Successfully! ‚úÖ";
        } else {
            await addDoc(collection(db, "products"), productObj);
            status.innerText="Added Successfully! ‚úÖ";
        }
        clearForm();
    } catch (err) { status.innerText="Error Saving Product! ‚ùå"; }
}

window.toggleStock = async function(id, currentStockStatus) {
    try {
        await updateDoc(doc(db, "products", id), { inStock: !currentStockStatus });
    } catch (err) { alert("Error updating stock: " + err.message); }
}

function loadProducts(){
    onSnapshot(collection(db, "products"), (snapshot) => {
        const table = document.getElementById("product-table");
        table.innerHTML = "";
        document.getElementById("total").innerText = snapshot.size;
        
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const isInStock = data.inStock !== false; 
            const stockStatusTxt = isInStock ? "In Stock ‚úÖ" : "Out of Stock ‚ùå";
            const stockColor = isInStock ? "#28a745" : "#dc3545";
            const toggleBtnTxt = isInStock ? "Mark Out of Stock" : "Mark In Stock";
            const toggleBtnColor = isInStock ? "#6c757d" : "#28a745";

            table.innerHTML += `<tr>
                <td><img src="${data.imageUrl}" class="order-img"></td>
                <td>
                    <b>${data.productName}</b><br>
                    <span style="color:${stockColor}; font-weight:bold; font-size:12px;">${stockStatusTxt}</span>
                </td>
                <td>‚Çπ${data.price}</td>
                <td>
                    <button style="background:${toggleBtnColor}; color:#fff; margin-bottom:5px; width:100%; border-radius:4px; padding:8px; border:none; cursor:pointer; font-weight:bold;" 
                            onclick="toggleStock('${docSnap.id}', ${isInStock})">
                        ${toggleBtnTxt}
                    </button><br>
                    <button class="edit-btn" onclick="editProduct('${docSnap.id}','${data.productName}','${data.price}','${data.description || ""}')">Edit</button>
                    <button class="delete-btn" onclick="deleteProduct('${docSnap.id}')">Delete</button>
                </td>
            </tr>`;
        });
    });
}

window.updateOrderStatus = async function(orderId, newStatus) {
    try { await updateDoc(doc(db, "orders", orderId), { status: newStatus }); } catch (err) { }
}

function loadOrders(){
    const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
        const table = document.getElementById("orders-table");
        table.innerHTML = "";
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const orderId = docSnap.id;
            
            let statusColor = "#ef6c00"; 
            if(data.status === 'Shipped') statusColor = "#007bff";
            if(data.status === 'Delivered') statusColor = "#28a745";
            if(data.status === 'Cancelled') statusColor = "#dc3545"; 

            const isDisabled = data.status === 'Cancelled' ? 'disabled' : '';

            table.innerHTML += `
            <tr>
                <td><img src="${data.imageUrl || 'image.png'}" class="order-img"></td>
                <td>
                    <b>${data.productName}</b><br>
                    <span style="display:inline-block; margin-top:5px; color:#ff3f6c; font-weight:bold; font-size:12px; background:#ffeef2; padding:3px 8px; border-radius:4px; border: 1px solid #ffccde;">
                        Size: ${data.size || 'Free Size'}
                    </span>
                </td>
                <td>‚Çπ${data.price}</td>
                <td class="buyer-info-box">
                    <span class="buyer-name">${data.buyerName || 'Unknown'}</span>
                    üìû ${data.buyerMobile || 'N/A'}<br>
                    üìç ${data.buyerAddress || 'N/A'}<br>
                    üìß <small>${data.user}</small>
                </td>
                <td>
                    <select class="status-select" onchange="updateOrderStatus('${orderId}', this.value)" 
                            style="color:${statusColor}; border-color:${statusColor};" ${isDisabled}>
                        <option value="Pending" ${data.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Shipped" ${data.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                        <option value="Delivered" ${data.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                        <option value="Cancelled" ${data.status === 'Cancelled' ? 'selected' : ''}>Cancelled üö´</option>
                    </select>
                </td>
            </tr>`;
        });
    });
}

/* MASS UPDATE: LOAD REVIEWS FUNCTION */
function loadAllReviews() {
    const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
        const table = document.getElementById("reviews-table");
        table.innerHTML = "";
        document.getElementById("total-reviews").innerText = snapshot.size;

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const dateStr = data.createdAt ? data.createdAt.toDate().toLocaleDateString() : "Just Now";
            let stars = "‚≠ê".repeat(data.rating);

            table.innerHTML += `
            <tr>
                <td><b style="color:var(--dark);">${data.productName}</b></td>
                <td class="buyer-info-box">
                    <span class="buyer-name">${data.userName}</span>
                    üìß <small>${data.userEmail}</small>
                </td>
                <td>
                    <div>${stars}</div>
                    <div style="font-size:13px; color:#555; margin-top:5px; font-style:italic;">"${data.comment}"</div>
                </td>
                <td>${dateStr}</td>
                <td>
                    <button class="delete-btn" onclick="deleteReview('${docSnap.id}')">Delete</button>
                </td>
            </tr>`;
        });
    });
}

// DELETE REVIEW FUNCTION
window.deleteReview = async function(id) {
    if(confirm("Are you sure you want to delete this review? üóëÔ∏è")) {
        try {
            await deleteDoc(doc(db, "reviews", id));
            alert("Review Deleted! ‚úÖ");
        } catch(err) {
            alert("Error deleting review: " + err.message);
        }
    }
}

window.editProduct = function(id, name, price, description){ 
    showTab('addProduct'); 
    document.getElementById("pName").value = name; 
    document.getElementById("pPrice").value = price; 
    document.getElementById("pDesc").value = description; 
    editId = id; 
}
window.deleteProduct = async function(id){ if(confirm("Delete product?")) await deleteDoc(doc(db, "products", id)); }
window.clearForm = function(){ 
    document.getElementById("pName").value=""; 
    document.getElementById("pPrice").value=""; 
    document.getElementById("pDesc").value=""; 
    document.querySelectorAll('.size-check').forEach(cb => cb.checked = false);
    for(let i=1; i<=6; i++){ document.getElementById("pImage" + i).value = ""; }
}
</script>
</body>
</html>
